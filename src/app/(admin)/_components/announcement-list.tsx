\"use client\";\n\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useGetInstructor } from \"../_hooks/instructor-hooks\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Edit, Trash2, Calendar } from \"lucide-react\";\nimport { useState } from \"react\";\n\nexport default function AnnouncementList() {\n  const { data: instructor } = useGetInstructor();\n  const instructorId = instructor?._id || instructor?.id;\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const [courseFilter, setCourseFilter] = useState(\"\");\n\n  const { data: courses } = useQuery({\n    queryKey: [\"instructor-courses\", instructorId],\n    queryFn: async () => {\n      if (!instructorId) return [];\n      const res = await fetch(`/api/courses?instructorId=${instructorId}`);\n      const data = await res.json();\n      return data.courses || [];\n    },\n    enabled: !!instructorId,\n  });\n\n  const { data, isLoading } = useQuery({\n    queryKey: [\"instructor-announcements\", instructorId, courseFilter],\n    queryFn: async () => {\n      if (!instructorId) return { announcements: [] };\n      const params = new URLSearchParams({ instructorId });\n      if (courseFilter) params.set(\"courseId\", courseFilter);\n      const res = await fetch(`/api/instructor/announcements?${params.toString()}`);\n      return res.json();\n    },\n    enabled: !!instructorId,\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (announcementId: string) => {\n      const res = await fetch(`/api/instructor/announcements?announcementId=${announcementId}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"instructor-announcements\"] });\n      toast({ title: \"Announcement deleted\" });\n    },\n    onError: () => toast({ title: \"Failed to delete\", variant: \"destructive\" }),\n  });\n\n  const patchMutation = useMutation({\n    mutationFn: async (payload: any) => {\n      const res = await fetch(`/api/instructor/announcements`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      });\n      if (!res.ok) throw new Error(\"Failed to update\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"instructor-announcements\"] });\n      toast({ title: \"Announcement updated\" });\n    },\n    onError: () => toast({ title: \"Failed to update\", variant: \"destructive\" }),\n  });\n\n  if (!instructorId) return null;\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <CardTitle>Announcements</CardTitle>\n          <Select value={courseFilter} onValueChange={setCourseFilter}>\n            <SelectTrigger className=\"w-[220px]\"><SelectValue placeholder=\"All courses\" /></SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"\">All courses</SelectItem>\n              {(courses || []).map((c: any) => (\n                <SelectItem key={c._id} value={c._id}>{c.title}</SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"text-center p-8\">Loading...</div>\n        ) : (data?.announcements || []).length === 0 ? (\n          <div className=\"text-center p-8 text-gray-500\">No announcements found</div>\n        ) : (\n          <div className=\"space-y-3\">\n            {data.announcements.map((a: any) => (\n              <AnnouncementRow key={a._id} a={a} onDelete={() => deleteMutation.mutate(a._id)} onSave={(updates) => patchMutation.mutate({ announcementId: a._id, ...updates })} />\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction AnnouncementRow({ a, onDelete, onSave }: { a: any; onDelete: () => void; onSave: (updates: any) => void }) {\n  const [editing, setEditing] = useState(false);\n  const [title, setTitle] = useState(a.title);\n  const [content, setContent] = useState(a.content);\n  const [scheduled, setScheduled] = useState(a.scheduledFor ? new Date(a.scheduledFor).toISOString().slice(0,16) : \"\");\n\n  return (\n    <div className=\"p-4 bg-gray-50 rounded-lg border\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <p className=\"font-medium\">{a.course?.title || \"Course\"}</p>\n          <p className=\"text-xs text-gray-500\">Status: {a.status} â€¢ Recipients: {a.recipients}</p>\n        </div>\n        <div className=\"text-xs text-gray-500\">{new Date(a.createdAt).toLocaleString()}</div>\n      </div>\n\n      {!editing ? (\n        <div className=\"mt-2\">\n          <h4 className=\"font-semibold mb-1\">{a.title}</h4>\n          <p className=\"text-sm text-gray-700 whitespace-pre-wrap\">{a.content}</p>\n        </div>\n      ) : (\n        <div className=\"mt-2 space-y-2\">\n          <Input value={title} onChange={(e) => setTitle(e.target.value)} />\n          <Textarea value={content} onChange={(e) => setContent(e.target.value)} rows={4} />\n          <div className=\"flex items-center gap-2\">\n            <Calendar className=\"w-4 h-4\" />\n            <Input type=\"datetime-local\" value={scheduled} onChange={(e) => setScheduled(e.target.value)} />\n          </div>\n        </div>\n      )}\n\n      <div className=\"mt-3 flex gap-2\">\n        {!editing ? (\n          <>\n            <Button size=\"sm\" variant=\"outline\" onClick={() => setEditing(true)}><Edit className=\"w-4 h-4 mr-2\" /> Edit</Button>\n            <Button size=\"sm\" variant=\"outline\" className=\"text-red-600 border-red-200\" onClick={onDelete}><Trash2 className=\"w-4 h-4 mr-2\" /> Delete</Button>\n          </>\n        ) : (\n          <>\n            <Button size=\"sm\" onClick={() => { onSave({ title, content, scheduledFor: scheduled || null }); setEditing(false); }}>Save</Button>\n            <Button size=\"sm\" variant=\"outline\" onClick={() => { setEditing(false); setTitle(a.title); setContent(a.content); setScheduled(a.scheduledFor ? new Date(a.scheduledFor).toISOString().slice(0,16) : \"\"); }}>Cancel</Button>\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n