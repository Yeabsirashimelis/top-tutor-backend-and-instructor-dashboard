\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from \"@/components/ui/select\";\nimport { MessageSquare, Mail, Filter, Search, Pin, PinOff, CheckCircle2 } from \"lucide-react\";\nimport { useGetInstructor } from \"../_hooks/instructor-hooks\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function MessagesInbox() {\n  const { data: instructor } = useGetInstructor();\n  const instructorId = instructor?._id || instructor?.id;\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const [qaStatus, setQaStatus] = useState<string>(\"pending\");\n  const [courseFilter, setCourseFilter] = useState<string>(\"\");\n  const [dmStatus, setDmStatus] = useState<string>(\"all\");\n\n  const { data: courses } = useQuery({\n    queryKey: [\"instructor-courses\", instructorId],\n    queryFn: async () => {\n      if (!instructorId) return [];\n      const res = await fetch(`/api/courses?instructorId=${instructorId}`);\n      const data = await res.json();\n      return data.courses || [];\n    },\n    enabled: !!instructorId,\n  });\n\n  const { data, isLoading } = useQuery({\n    queryKey: [\"instructor-messages\", instructorId, qaStatus, courseFilter, dmStatus],\n    queryFn: async () => {\n      if (!instructorId) return null;\n      const params = new URLSearchParams({ instructorId, type: \"all\" });\n      if (courseFilter) params.set(\"courseId\", courseFilter);\n      if (qaStatus) params.set(\"status\", qaStatus);\n      // dmStatus handled on client (unread/all) for simplicity\n      const res = await fetch(`/api/instructor/messages?${params.toString()}`);\n      return res.json();\n    },\n    enabled: !!instructorId,\n    staleTime: 60 * 1000,\n  });\n\n  const qaMessages = useMemo(() => {\n    if (!data?.qaMessages) return [];\n    return data.qaMessages;\n  }, [data]);\n\n  const directMessages = useMemo(() => {\n    if (!data?.directMessages) return [];\n    if (dmStatus === \"unread\") return data.directMessages.filter((m: any) => !m.isRead);\n    return data.directMessages;\n  }, [data, dmStatus]);\n\n  const unread = data?.unreadCounts || { qa: 0, direct: 0, total: 0 };\n\n  // Mutations\n  const answerMutation = useMutation({\n    mutationFn: async ({ messageId, answer }: { messageId: string; answer: string }) => {\n      const res = await fetch(\"/api/instructor/messages\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ type: \"qa-answer\", messageId, answer }),\n      });\n      if (!res.ok) throw new Error(\"Failed to post answer\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"instructor-messages\"] });\n      toast({ title: \"Answer posted\", description: \"Your reply has been sent.\" });\n    },\n    onError: () => toast({ title: \"Failed to post answer\", variant: \"destructive\" }),\n  });\n\n  const updateQAMutation = useMutation({\n    mutationFn: async ({ messageId, updates }: { messageId: string; updates: any }) => {\n      const res = await fetch(\"/api/instructor/messages\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ type: \"qa\", messageId, ...updates }),\n      });\n      if (!res.ok) throw new Error(\"Failed to update Q&A\");\n      return res.json();\n    },\n    onSuccess: () => queryClient.invalidateQueries({ queryKey: [\"instructor-messages\"] }),\n    onError: () => toast({ title: \"Failed to update\", variant: \"destructive\" }),\n  });\n\n  const updateDMMutation = useMutation({\n    mutationFn: async ({ messageId, updates }: { messageId: string; updates: any }) => {\n      const res = await fetch(\"/api/instructor/messages\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ type: \"direct\", messageId, ...updates }),\n      });\n      if (!res.ok) throw new Error(\"Failed to update message\");\n      return res.json();\n    },\n    onSuccess: () => queryClient.invalidateQueries({ queryKey: [\"instructor-messages\"] }),\n    onError: () => toast({ title: \"Failed to update\", variant: \"destructive\" }),\n  });\n\n  if (!instructorId) return null;\n\n  return (\n    <div className=\"space-y-6 p-2\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-2xl font-bold\">Messages</h1>\n        <Badge>Unread: {unread.total}</Badge>\n      </div>\n\n      <Tabs defaultValue=\"qa\">\n        <TabsList>\n          <TabsTrigger value=\"qa\"><MessageSquare className=\"w-4 h-4 mr-2\" />Q&A ({unread.qa})</TabsTrigger>\n          <TabsTrigger value=\"direct\"><Mail className=\"w-4 h-4 mr-2\" />Direct ({unread.direct})</TabsTrigger>\n        </TabsList>\n\n        {/* Q&A Tab */}\n        <TabsContent value=\"qa\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle>Course Q&A</CardTitle>\n                <div className=\"flex gap-2 items-center\">\n                  <Select value={courseFilter} onValueChange={setCourseFilter}>\n                    <SelectTrigger className=\"w-[200px]\"><SelectValue placeholder=\"All courses\" /></SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"\">All courses</SelectItem>\n                      {(courses || []).map((c: any) => (\n                        <SelectItem key={c._id} value={c._id}>{c.title}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <Select value={qaStatus} onValueChange={setQaStatus}>\n                    <SelectTrigger className=\"w-[160px]\"><SelectValue /></SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"pending\">Pending</SelectItem>\n                      <SelectItem value=\"answered\">Answered</SelectItem>\n                      <SelectItem value=\"archived\">Archived</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <div className=\"text-center p-8\">Loading...</div>\n              ) : qaMessages.length === 0 ? (\n                <div className=\"text-center p-8 text-gray-500\">No Q&A messages</div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {qaMessages.map((m: any) => (\n                    <QACard key={m._id} m={m} onAnswer={(answer) => answerMutation.mutate({ messageId: m._id, answer })} onPin={(pin) => updateQAMutation.mutate({ messageId: m._id, updates: { isPinned: pin } })} />\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Direct Messages */}\n        <TabsContent value=\"direct\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle>Direct Messages</CardTitle>\n                <div className=\"flex gap-2 items-center\">\n                  <Select value={dmStatus} onValueChange={setDmStatus}>\n                    <SelectTrigger className=\"w-[140px]\"><SelectValue /></SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All</SelectItem>\n                      <SelectItem value=\"unread\">Unread</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <div className=\"text-center p-8\">Loading...</div>\n              ) : directMessages.length === 0 ? (\n                <div className=\"text-center p-8 text-gray-500\">No direct messages</div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {directMessages.map((m: any) => (\n                    <DMCard key={m._id} m={m} onMarkRead={(read) => updateDMMutation.mutate({ messageId: m._id, updates: { isRead: read } })} />\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n\nfunction QACard({ m, onAnswer, onPin }: { m: any; onAnswer: (answer: string) => void; onPin: (pin: boolean) => void }) {\n  const [answer, setAnswer] = useState(\"\");\n  const [open, setOpen] = useState(false);\n\n  useEffect(() => {\n    if (m.answer) setAnswer(m.answer);\n  }, [m.answer]);\n\n  return (\n    <div className=\"p-4 bg-gray-50 rounded-lg border\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <p className=\"font-medium\">{m.student?.name} • {m.course?.title}{m.lecture ? ` • ${m.lecture.title}` : ''}</p>\n          <p className=\"text-sm text-gray-600\">{m.question}</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {m.isPinned ? (\n            <Button size=\"sm\" variant=\"outline\" onClick={() => onPin(false)} title=\"Unpin\"><PinOff className=\"w-4 h-4\" /></Button>\n          ) : (\n            <Button size=\"sm\" variant=\"outline\" onClick={() => onPin(true)} title=\"Pin\"><Pin className=\"w-4 h-4\" /></Button>\n          )}\n        </div>\n      </div>\n\n      {m.answer ? (\n        <div className=\"mt-3 p-3 bg-white rounded border\">\n          <p className=\"text-sm\"><span className=\"font-semibold\">Answer:</span> {m.answer}</p>\n        </div>\n      ) : (\n        <div className=\"mt-3\">\n          <Label htmlFor={`answer-${m._id}`}>Your Answer</Label>\n          <Textarea id={`answer-${m._id}`} value={answer} onChange={(e) => setAnswer(e.target.value)} rows={3} placeholder=\"Type your reply...\" />\n          <div className=\"mt-2\">\n            <Button size=\"sm\" disabled={!answer.trim()} onClick={() => onAnswer(answer)}>\n              <CheckCircle2 className=\"w-4 h-4 mr-2\" /> Post Answer\n            </Button>\n          </div>\n        </div>\n      )}\n\n      <div className=\"text-xs text-gray-500 mt-2\">{new Date(m.createdAt).toLocaleString()}</div>\n    </div>\n  );\n}\n\nfunction DMCard({ m, onMarkRead }: { m: any; onMarkRead: (read: boolean) => void }) {\n  return (\n    <div className=\"p-4 bg-gray-50 rounded-lg border\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <p className=\"font-medium\">{m.sender?.name}{m.course ? ` • ${m.course.title}` : ''}</p>\n          <p className=\"text-sm text-gray-600\">{m.subject || 'No Subject'}</p>\n        </div>\n        <div className=\"text-xs text-gray-500\">{new Date(m.createdAt).toLocaleString()}</div>\n      </div>\n      <div className=\"mt-2 p-3 bg-white rounded border\"><p className=\"text-sm\">{m.message}</p></div>\n      <div className=\"mt-2 flex gap-2\">\n        {m.isRead ? (\n          <Button size=\"sm\" variant=\"outline\" onClick={() => onMarkRead(false)}>Mark Unread</Button>\n        ) : (\n          <Button size=\"sm\" onClick={() => onMarkRead(true)}>Mark Read</Button>\n        )}\n      </div>\n    </div>\n  );\n}\n